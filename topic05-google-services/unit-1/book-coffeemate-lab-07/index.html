<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css"
          type="text/css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"
          rel="stylesheet"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
      

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



      

html, body {
  height: 100%;
  margin: 0;
}
.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.footer {
  background: white;
  text-align: right;
}
.content {
  flex: 1;
  overflow: auto;
}



    </style>
  </head>

  
  

  <div class="ui fixed top pointing inverted stackable menu labmenu">
    <header class="header item">
      <i id="toc" class="sitemap icon"></i>
      
        <a href="../../index.html"> Google Services, Sign In, Location & Maps  </a>
      
    </header>
    <div class="right tab-menu menu">
      
        <a class="item" data-tab="Lab-07">
          Lab-07
        </a>
      
        <a class="item" data-tab="01">
          01
        </a>
      
        <a class="item" data-tab="02">
          02
        </a>
      
        <a class="item" data-tab="03">
          03
        </a>
      
        <a class="item" data-tab="04">
          04
        </a>
      
        <a class="item" data-tab="05">
          05
        </a>
      
        <a class="item" data-tab="06">
          06
        </a>
      
        <a class="item" data-tab="Solution">
          Solution
        </a>
      
    </div>
  </div>


  

  <div class="ui pushable">
    <div class="ui inverted labeled icon left inline vertical sidebar menu">
      <br><br>
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic01-overview-and-tools/unit-1/book-coffeemate-lab-01/index.html">Lab-01 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic02-ui-design/unit-1/book-coffeemate-lab-02/index.html">Lab-02 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic02-ui-design/unit-1/book-coffeemate-lab-03/index.html">Lab-03 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic02-ui-design/unit-2/book-coffeemate-lab-04/index.html">Lab-04 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic03-persistence/unit-1/book-coffeemate-lab-05-a/index.html">Lab-05-a </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic03-persistence/unit-1/book-coffeemate-lab-05-b/index.html">Lab-05-b </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic04-networking/unit-1/book-coffeemate-lab-06-a/index.html">Lab-06-a </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic04-networking/unit-1/book-coffeemate-lab-06-b/index.html">Lab-06-b </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic05-google-services/unit-1/book-coffeemate-lab-07/index.html">Lab-07 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic05-google-services/unit-1/book-coffeemate-lab-08/index.html">Lab-08 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic06-firebase/unit-1/book-coffeemate-lab-09/index.html">Lab-09 </a>
          
        
      
    </div>
    <div class="pusher" tabindex="-1">
      <div class="ui basic segment">
        <br>
        
          <div class="ui tab segment lab" data-tab="Lab-07">
            <h1>Objectives</h1>
<p>This lab continues our Case Study <b>CoffeeMate</b> and once again, yet another major refactoring of the app, where we introduce some basic security using <b>Google Sign-in</b>.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="01">
            <h1>Setting Up Google Sign-in</h1>
<p>As we&#39;ll need to make a few http requests, we&#39;ll start with <a href="archives/CoffeeMate.6a.0.Solution.zip">CoffeeMate.6a.0</a> as this has <strong>VOLLEY</strong> implemented, but you could in theory, continue on with your own version.</p>
<p>We now want our CoffeeMate App to interact with our Web App (<a href="http://coffeemate-fullfat.herokuapp.com">CoffeeMate-FULLFAT-nodeserver</a>) AND allow the user to manage their own specific coffees, so we&#39;ll use <b>Google Sign-in</b> support to allow us to connect to the Web App and Add/Edit/Delete/View User Coffees stored on the Server.</p>
<p>Before you can start integrating Google Services features in your own app, you must create a <b><i>Google Developers Console project</i></b> and initialise the <b>GoogleApiClient</b> within your app.</p>
<h3>Step 1: Configure for Google Sign-In</h3>
<p>Before you begin using Google Services in your Android app, follow all of the steps to <a href="https://developers.google.com/identity/sign-in/android/start-integrating">Start Integrating Google Sign-In into your Android App</a>.</p>
<h3>Step 2: Enable the Google+ API</h3>
<p>If you followed the steps above correctly, to add Google Sign-In to your app, you have already created a project in Google Developers Console. Now enable the Google+ API for that project to access Google+ features.</p>
<ul>
<li>Go to the <a href="https://console.developers.google.com/project/_/apiui/apis/library"><Google Developers Console APIs library</a>.</li>
<li>From the project drop-down, select the <a href="https://support.google.com/cloud/answer/6158853">project</a> you previously created.</li>
<li>In the list of Google APIs, search for the <b>Google+ API</b> service.</li>
<li>Select <b>Google+ API</b> from the results list.</li>
<li>Select <b>Enable API</b>.</li>
</ul>
<p>When the process completes, <b>Google+ API</b> appears in the list of enabled APIs. To access, select <b>API Manager</b> on the left sidebar menu, then select the <b>Enabled APIs</b> tab.</p>
<h3>Step 3: Create our Login Page &amp; Google instance variables</h3>
<p>Here we&#39;ll just create a standard Login Page through Android Studio, so go ahead and Add a new <code>Login</code> activity like so</p>
<p><img src="img/login1.png" alt=""></p>
<p>and</p>
<p><img src="img/login2.png" alt=""></p>
<p>You might get a &#39;git&#39; dialog box, which you can just choose ok</p>
<p><img src="img/git.png" alt=""></p>
<p>Then add the following dependency to your <strong>app/build.gradle</strong></p>
<pre><code class="lang-xml">implementation &#39;com.shobhitpuri.custombuttons:google-signin:1.0.0&#39;</code></pre>
<p>add the following button to your new &#39;login&#39; layout (and don&#39;t forget a new String Resource &#39;google_sign_up&#39;)</p>
<pre><code class="lang-xml">&lt;com.shobhitpuri.custombuttons.GoogleSignInButton
               android:id=&quot;@+id/google_sigin_button&quot;
               android:layout_width=&quot;match_parent&quot;
               android:layout_height=&quot;64dp&quot;
               android:elevation=&quot;9dp&quot;
               android:text=&quot;@string/google_sign_up&quot;
               android:textSize=&quot;18sp&quot;
               app:isDarkTheme=&quot;true&quot; /&gt;</code></pre>
<p>You might need to add the following to your layout</p>
<pre><code class="lang-xml">xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;</code></pre>
<p> You should now have something like this</p>
<p> <img src="img/login3.png" alt=""></p>
<p> We&#39;re actually going to bypass the manual signin/register for the moment (and all the boilerplate code supplied!) and just focus on signing in with Google.</p>
<p> Finally, add the following to your <code>CoffeeMateApp</code> declarations</p>
<pre><code class="lang-java"> /* Client used to interact with Google APIs. */
    public GoogleApiClient mGoogleApiClient;
    public GoogleSignInOptions mGoogleSignInOptions;

    public boolean signedIn = false;
    public String googleToken;
    public String googleName;
    public String googleMail;
    public String googlePhotoURL;
    public Bitmap googlePhoto;</code></pre>
<p>and fix any import errors.</p>
<p>We&#39;re now ready to set up the Login process.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="02">
            <h1>Implementing Google Sign-in</h1>
<p>What we want is something like this:</p>
<p>The user launches the app</p>
<p> <img src="img/signin0.png" alt=""></p>
<p>and (after a Splash Screen) is prompted to <code>Sign In with Google</code>, like so</p>
<p><img src="img/signin1.png" alt=""></p>
<p>If the user hasn&#39;t previously logged in, they will be asked to choose an existing Account, or add a different account (that&#39;s what we&#39;ll do here)</p>
<p><img src="img/signin2.png" alt=""></p>
<p>The user is then prompted for their Google credentials</p>
<p><img src="img/signin3.png" alt=""></p>
<p><img src="img/signin4.png" alt=""></p>
<p>and then asked to agree to the usual...</p>
<p><img src="img/signin5.png" alt=""></p>
<p>The additional account can now be chosen as the active Google account in the app</p>
<p><img src="img/signin6.png" alt=""></p>
<p>and we can display the users Google Profile pic, and email in the Navigation Drawer like so (I&#39;m logged in here)</p>
<p><img src="img/signin7.png" alt=""></p>
<hr>
<p>There&#39;s quite a lot of code (relatively speaking) to get this off the ground, so we&#39;ll use this step as more of a &#39;configuration&#39; step, and hopefully once you&#39;ve completed this, you&#39;ll be able to <strong>&#39;Go Green&#39;</strong> on your own app :-) (Reduce,Reuse,Recycle my code).</p>
<p>We&#39;ll be phasing out our <strong>Base</strong> class here too, so the first step is keeping a reference to our application object and Dialog in <strong>Home</strong>, like so</p>
<pre><code class="lang-java">public static CoffeeMateApp app = CoffeeMateApp.getInstance();
public AlertDialog loader;</code></pre>
<p>Make sure you move the <strong>createLoader()</strong> and <strong>menu</strong> methods to <code>Home</code> and remove the references from <strong>Base</strong> and fix any errors.</p>
<p>You should now be able to delete the <code>Base</code> class altogether.</p>
<p>Now bring in the following method into your <strong>Home</strong> activity class</p>
<pre><code class="lang-java">// [START signOut]
    public void menuSignOut(MenuItem m) {

        //https://stackoverflow.com/questions/38039320/googleapiclient-is-not-connected-yet-on-logout-when-using-firebase-auth-with-g
        app.mGoogleApiClient.connect();
        app.mGoogleApiClient.registerConnectionCallbacks(new GoogleApiClient.ConnectionCallbacks() {
            @Override
            public void onConnected(@Nullable Bundle bundle) {

                //FirebaseAuth.getInstance().signOut();
                if(app.mGoogleApiClient.isConnected()) {
                    Auth.GoogleSignInApi.signOut(app.mGoogleApiClient).setResultCallback(new ResultCallback&lt;Status&gt;() {
                        @Override
                        public void onResult(@NonNull Status status) {
                            if (status.isSuccess()) {
                                //Log.v(&quot;coffeemate&quot;, &quot;User Logged out&quot;);
                                Intent intent = new Intent(Home.this, Login.class);
                                startActivity(intent);
                                finish();
                            }
                        }
                    });
                }
            }

            @Override
            public void onConnectionSuspended(int i) {
                 Toast.makeText(Home.this, &quot;Google API Client Connection Suspended&quot;,Toast.LENGTH_SHORT).show();
            }
        });
    }
    // [END signOut]</code></pre>
<p>Also, just confirm that you have the following permissions in your manifest file</p>
<pre><code class="lang-xml">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;</code></pre>
<p>and the following in your build.gradle</p>
<pre><code class="lang-xml">implementation &#39;com.google.android.gms:play-services-auth:15.0.1&#39;</code></pre>
<p>Next, bring in a &#39;Logout&#39; Option in your Menu, like so</p>
<pre><code class="lang-xml">&lt;item
        android:id=&quot;@+id/menu_signout&quot;
        android:title=&quot;Logout&quot;
        android:orderInCategory=&quot;100&quot;
        app:showAsAction=&quot;never&quot;
        android:onClick=&quot;menuSignOut&quot;/&gt;</code></pre>
<p>Now, introduce the following variable in your <strong>Home</strong> Activity</p>
<pre><code class="lang-java">private ImageView googlePhoto;</code></pre>
<p>and the following code in your <strong>onCreate()</strong> method <strong>BEFORE</strong> your fragment transaction</p>
<pre><code class="lang-java">//SetUp GooglePhoto and Email for Drawer here
        googlePhoto = navigationView.getHeaderView(0).findViewById(R.id.googlephoto);
        CoffeeApi.getGooglePhoto(app.googlePhotoURL,googlePhoto);

        TextView googleName = navigationView.getHeaderView(0).findViewById(R.id.googlename);
        googleName.setText(app.googleName);

        TextView googleMail = navigationView.getHeaderView(0).findViewById(R.id.googlemail);
        googleMail.setText(app.googleMail);</code></pre>
<p>You&#39;ll get an error on</p>
<pre><code class="lang-java">CoffeeApi.getGooglePhoto(app.googlePhotoURL,googlePhoto);</code></pre>
<p>so add the following method to your <strong>CoffeeApi</strong> class</p>
<pre><code class="lang-java">public static void getGooglePhoto(String url,final ImageView googlePhoto) {
        ImageRequest imgRequest = new ImageRequest(url,
                new Response.Listener&lt;Bitmap&gt;() {
                    @Override
                    public void onResponse(Bitmap response) {
                        Home.app.googlePhoto = response;
                        googlePhoto.setImageBitmap(Home.app.googlePhoto);
                    }
                }, 0, 0, ImageView.ScaleType.FIT_XY, Bitmap.Config.ARGB_8888,

                new Response.ErrorListener() {
                    @Override
                    public void onErrorResponse(VolleyError error) {
                        System.out.println(&quot;Something went wrong!&quot;);
                        error.printStackTrace();
                    }
                });
        // Add the request to the queue
        Home.app.add(imgRequest);
    }</code></pre>
<p>If you get errors on <strong><em>googlename</em></strong> and <strong><em>googlemail</em></strong>, just confirm the following in your &#39;nav_header_home.xml&#39;</p>
<p><img src="img/navdrawer.png" alt=""></p>
<p>We should probably also allow the user to &#39;disconnect&#39; their account from the app so add the following to your login layout (and add the necessary string resource)</p>
<pre><code class="lang-xml">&lt;com.shobhitpuri.custombuttons.GoogleSignInButton
    android:id=&quot;@+id/google_disconnect_button&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;64dp&quot;
    android:elevation=&quot;9dp&quot;
    android:text=&quot;@string/google_disconnect&quot;
    android:textSize=&quot;18sp&quot;
    app:isDarkTheme=&quot;false&quot; /&gt;</code></pre>
<p>and you&#39;ll get something like this</p>
<p><img src="img/disconnect.png" alt=""></p>
<p>Now we&#39;re ready to start the actual login process</p>
<h2>Building the Google Client</h2>
<p>First, open your existing <code>Login</code> class and add the following declarations</p>
<pre><code class="lang-java">public CoffeeMateApp app = CoffeeMateApp.getInstance();
 /* Request code used to invoke sign in user interactions. */
private static final int RC_SIGN_IN = 0;
private static final String TAG = &quot;coffeemate&quot;;</code></pre>
<p>then go to your <strong>onCreate()</strong> and add the following</p>
<pre><code class="lang-java">// [START configure_signin]
       // Configure sign-in to request the user&#39;s ID, email address, and basic
       // profile. ID and basic profile are included in DEFAULT_SIGN_IN.
       app.mGoogleSignInOptions = new GoogleSignInOptions
               .Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)
               .requestEmail()
               .requestProfile()
               .build();
       // [END configure_signin]

       // [START build_client]
       // Build a GoogleApiClient with access to the Google Sign-In API and the
       // options specified by mGoogleSignInOptions.
       app.mGoogleApiClient = new GoogleApiClient.Builder(this)
               .enableAutoManage(this /* FragmentActivity */,
                       this /* OnConnectionFailedListener */)
               .addApi(Auth.GOOGLE_SIGN_IN_API, app.mGoogleSignInOptions)
               .build();
       // [END build_client]

       findViewById(R.id.google_sigin_button).setOnClickListener(this);
       findViewById(R.id.google_disconnect_button).setOnClickListener(this);</code></pre>
<p>Fix the import errors and then the remaining errors by implementing the necessary interfaces, like so</p>
<p><img src="img/google1.png" alt=""></p>
<p>and</p>
<p><img src="img/google2.png" alt=""></p>
<p>Next, add the following</p>
<pre><code class="lang-java">// [START signIn]
   private void signIn() {
       Intent signInIntent = Auth.GoogleSignInApi.getSignInIntent(app.mGoogleApiClient);
       startActivityForResult(signInIntent, RC_SIGN_IN);
   }
   // [END signIn]

   // [START revokeAccess]
   private void revokeAccess() {
       Auth.GoogleSignInApi.revokeAccess(app.mGoogleApiClient).setResultCallback(
               new ResultCallback&lt;Status&gt;() {
                   @Override
                   public void onResult(Status status) {
                       // [START_EXCLUDE]
                       startLoginScreen();
                       // [END_EXCLUDE]
                   }
               });
   }
   // [END revokeAccess]

   private void startHomeScreen() {
       Intent intent = new Intent(this, Home.class);
       startActivity(intent);
   }

   private void startLoginScreen() {
       Intent intent = new Intent(this, Login.class);
       startActivity(intent);
   }</code></pre>
<p>and replace the implemented methods with these</p>
<pre><code class="lang-java">@Override
 public void onClick(View v) {

     if (v.getId() == R.id.google_sigin_button) {
         signIn();
     }
     else
     if (v.getId() == R.id.google_disconnect_button) {
         revokeAccess();
     }
 }

 @Override
 public void onConnectionFailed(ConnectionResult connectionResult) {
     Toast.makeText(this, &quot;Error Signing in to Google &quot; + connectionResult, Toast.LENGTH_LONG).show();
     Log.v(TAG, &quot;ConnectionResult : &quot; + connectionResult);
 }</code></pre>
<p>You then need to add the following to <strong>start</strong> and <strong>handle</strong> the sign in process</p>
<pre><code class="lang-java">@Override
    public void onStart() {
        super.onStart();

        OptionalPendingResult&lt;GoogleSignInResult&gt; opr = Auth.GoogleSignInApi.silentSignIn(app.mGoogleApiClient);
        if (opr.isDone()) {
            // If the user&#39;s cached credentials are valid, the OptionalPendingResult will be &quot;done&quot;
            // and the GoogleSignInResult will be available instantly.
            Log.d(TAG, &quot;Got cached sign-in&quot;);
            GoogleSignInResult result = opr.get();
            handleSignInResult(result);
        } else {
            // If the user has not previously signed in on this device or the sign-in has expired,
            // this asynchronous branch will attempt to sign in the user silently.  Cross-device
            // single sign-on will occur in this branch.
            //showProgressDialog();
            opr.setResultCallback(new ResultCallback&lt;GoogleSignInResult&gt;() {
                @Override
                public void onResult(GoogleSignInResult googleSignInResult) {
                    handleSignInResult(googleSignInResult);
                }
            });
        }
    }

    // [START onActivityResult]
    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);

        // Result returned from launching the Intent from GoogleSignInApi.getSignInIntent(...);
        if (requestCode == RC_SIGN_IN) {
            GoogleSignInResult result = Auth.GoogleSignInApi.getSignInResultFromIntent(data);
            handleSignInResult(result);
        }
    }
    // [END onActivityResult]

    // [START handleSignInResult]
    private void handleSignInResult(GoogleSignInResult result) {
        Log.d(TAG, &quot;handleSignInResult:&quot; + result.isSuccess());
        if (result.isSuccess()) {
            // Signed in successfully, show authenticated UI.
            GoogleSignInAccount acct = result.getSignInAccount();
            app.googleName = acct.getDisplayName();

            // by default the profile url gives 50x50 px image only
            // we can replace the value with whatever dimension we want by
            // replacing sz=X
//            personPhotoUrl = personPhotoUrl.substring(0,
//                    personPhotoUrl.length() - 2)
//                    + 100;

            app.googleToken = acct.getId();
            app.signedIn = true;
            app.googleMail = acct.getEmail();
            if(acct.getPhotoUrl() == null)
                ; //New Account may not have Google+ photo
            else app.googlePhotoURL = acct.getPhotoUrl().toString();

            // Show a message to the user that we are signing in.
            Toast.makeText(this, &quot;Signing in &quot; + app.googleName +&quot; with &quot; + app.googleMail , Toast.LENGTH_SHORT).show();
            startHomeScreen();
        } else
            Toast.makeText(this, &quot;Please Sign in &quot; , Toast.LENGTH_SHORT).show();
    }
    // [END handleSignInResult]</code></pre>
<p>There&#39;s 2 other small steps, but vital ones, to get your Login Screen loading after your splash Screen and getting the correct coffees - and I&#39;ll leave that up to you.</p>
<p>Once you get the app running and a user Signing in - you&#39;ll see that the list can be downloaded as before, and the users Google credentials are displayed in the Nav Drawer - but these coffees aren&#39;t associated with any user, they&#39;re just stored on the server anonymously, so to speak - the rest of the lab involves refactoring our code to make API requests on the Server to Add/Delete/Update etc. users coffees specifically.</p>
<p>To save you time, and if you ran into any configuration issues, here&#39;s a version of CoffeeMate up to this point <a href="archives/CoffeeMate.7.0.sofar.zip">CoffeeMate.7.0.sofar.zip</a></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="03">
            <h1>Google Integration - Retrieving &#39;My Coffees&#39;</h1>
<p>At the moment the user is seeing a list of <strong>all</strong> coffees stored on the server, so let&#39;s make the app a bit more user friendly and download <strong><em>only</em></strong> the users coffees.</p>
<p>This is actually a very simple step, all we need to do is modify our APi call and add the users Google credentials to the request (which we already have) like so:</p>
<pre><code class="lang-java">CoffeeApi.get(&quot;/coffees/&quot; + app.googleToken);</code></pre>
<p>so now when we run the app we only see the current users coffees - here&#39;s mine (at the time of the request)</p>
<p><img src="img/mine.png" alt=""></p>
<p>Make sure you&#39;re connecting to the <strong>full fat</strong> version of our web server and don&#39;t forget to update the other calls, as in when you delete, refresh etc.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="04">
            <h1>Google Integration - Adding a Coffee</h1>
<p>Adding a coffee is nearly as easy as the last step, as all we need to do is change 2 lines of code in our <code>AddFragment</code>.</p>
<p>It&#39;s virtually identical to the last step, so have a go at that now, and confirm that you can add <strong><em>your own</em></strong> coffees to the server.</p>
<p>If you notice that your coffees aren&#39;t being added as expected, can you work out why not? Again, this is an easy fix :)</p>
<p>As a hint, make sure, your <code>Coffee Model</code> matches your <code>JSON Model</code> on the Server.</p>
<h2>JSON From FULL FAT server</h2>
<pre><code class="lang-json">{
    &quot;status&quot;: 99,
    &quot;message&quot;: &quot;User Coffees Successfully Retrieved!&quot;,
    &quot;data&quot;: [
        {
            &quot;favourite&quot;: false,
            &quot;_id&quot;: &quot;5c00111111111116cd95b0&quot;,
            &quot;name&quot;: &quot;Standard Black lite&quot;,
            &quot;shop&quot;: &quot;Tescos&quot;,
            &quot;price&quot;: 1.99,
            &quot;rating&quot;: 2.5,
            &quot;marker&quot;: &quot;&quot;,
            &quot;address&quot;: &quot;&quot;,
            &quot;usertoken&quot;: &quot;111111111111111118125&quot;,
            &quot;googlephoto&quot;: &quot;https://l/photo.jpg&quot;,
            &quot;__v&quot;: 0
        },
        {
            &quot;favourite&quot;: false,
            &quot;_id&quot;: &quot;5c0012311111111116cd95b1&quot;,
            &quot;name&quot;: &quot;Mocca Latte&quot;,
            &quot;shop&quot;: &quot;Aldi&quot;,
            &quot;price&quot;: 2.99,
            &quot;rating&quot;: 3.5,
            &quot;marker&quot;: &quot;&quot;,
            &quot;address&quot;: &quot;&quot;,
            &quot;usertoken&quot;: &quot;111111111111111118125&quot;,
            &quot;googlephoto&quot;: &quot;https://l/photo.jpg&quot;,
            &quot;__v&quot;: 0
        },
        {
            &quot;favourite&quot;: true,
            &quot;_id&quot;: &quot;5c001251111111111195b2&quot;,
            &quot;name&quot;: &quot;Home Brew&quot;,
            &quot;shop&quot;: &quot;The gaff&quot;,
            &quot;price&quot;: 0.99,
            &quot;rating&quot;: 4.5,
            &quot;marker&quot;: &quot;&quot;,
            &quot;address&quot;: &quot;&quot;,
            &quot;usertoken&quot;: &quot;111111111111111118125&quot;,
            &quot;googlephoto&quot;: &quot;https://l/photo.jpg&quot;,
            &quot;__v&quot;: 0
        },
        {
            &quot;favourite&quot;: false,
            &quot;_id&quot;: &quot;5c00243f1111111111018aa&quot;,
            &quot;name&quot;: &quot;test&quot;,
            &quot;shop&quot;: &quot;shop&quot;,
            &quot;price&quot;: 1.99,
            &quot;rating&quot;: 2.5,
            &quot;usertoken&quot;: &quot;111111111111111118125&quot;,
            &quot;googlephoto&quot;: &quot;https://l/photo.jpg&quot;,
            &quot;__v&quot;: 0
        }
    ]
}</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="05">
            <h1>Google Integration - Updating a Coffee</h1>
<p>Updating a coffee is nearly as easy as adding, in that all we need to do is change a few lines of code in our <code>EditFragment</code>. We also need to make a minor change to our <code>CoffeeApi</code> <strong>PUT</strong>, but we&#39;ll get to that in a minute.</p>
<p>So, the first thing to do is make sure you can retrieve the users coffee and display in on the Edit screen, like so</p>
<p><img src="img/edit1.png" alt=""></p>
<p>To achieve this you&#39;ll need to modify how you <strong>GET</strong> the coffee from the server in your <code>EditFragment</code>, so try that now.</p>
<p>Next, to <strong>PUT</strong> the coffee, you need to make a similar change to how you save the coffee, so try that now too.</p>
<p>You&#39;ll notice that in the <strong>put()</strong> method in our <code>CoffeeApi</code> we&#39;re not passing in the <strong>usertoken</strong> when we force a <strong>get()</strong> to refresh our list of coffees, so this is where we need to refactor the method signature, and pass in the usertoken which we can then use to <strong>GET</strong> the coffees again.</p>
<p>This is just a matter of passing in a <em>String</em> variable to the method, representing the usertoken, so have a go at that now and see how you get on.</p>
<p>NOTE : As we&#39;re passing in the token already, there&#39;s a number of different solutions to this, so feel free to try your own.</p>
<p>If all goes to plan you should be able to edit a users coffee on the server and see this change when the user is returned to the screen they were on, prior to editing their coffee.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="06">
            <h1>Google Integration - Deleting Coffees</h1>
<p>As we already have all the necessary code in place from previous versions of CoffeeMate, AND we still have a full APi class available to us, this step is very simple - we just need to change our delete method(s) to delete the specific user coffee (or multiple coffees) from the server.</p>
<p>we achieve deleting a single coffee by calling our <strong>CoffeeApi</strong> &#39;delete&#39; method like so</p>
<pre><code class="lang-java">CoffeeApi.delete(&quot;/coffees/&quot; + app.googleToken +&quot;/&quot; + coffee._id);</code></pre>
<p>so see if you can work out where this call should go, and what code it should replace?</p>
<p>We can use the same method call to delete multiple coffees so try and have a go at implementing this feature (which was covered in the lectures).</p>
<p>After some testing, you may find that the delete isn&#39;t working as expected, so I&#39;d suggest taking the same approach as we took with updating - forcing a <strong>GET</strong> after we updated.</p>
<p>That completes this lab and you can find a solution on the next page.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="Solution">
            <h1>Solution</h1>
<p>This is a solution which uses a Web Service and <b>Volley</b> with <b>Google Sign-in</b> to manage the Coffees in the app:</p>
<ul>
<li><a href="archives/CoffeeMate.7.0.Solution.zip">CoffeeMate.7.0</a></li>
</ul>

          </div>
        
      </div>
    </div>
  </div>



  <script>
    $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

    $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

  </script>



  <div class="ui bottom fixed borderless right menu">
    <div class="ui right small menu">
      <div class="ui tiny basic message segment">
         Powered by <a href="https://github.com/edeleastar/tutors-ts">tutors-ts.</a> 
      </div>
    </div>
  </div>

  </body>

</html>