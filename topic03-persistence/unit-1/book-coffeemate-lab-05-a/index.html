<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.css"
          type="text/css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"
          rel="stylesheet"/>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.10/semantic.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
      

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



      

html, body {
  height: 100%;
  margin: 0;
}
.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.footer {
  background: white;
  text-align: right;
}
.content {
  flex: 1;
  overflow: auto;
}



    </style>
  </head>

  
  

  <div class="ui fixed top pointing inverted stackable menu labmenu">
    <header class="header item">
      <i id="toc" class="sitemap icon"></i>
      
        <a href="../../index.html"> Data Persistence using Shared Prefs, SQLite & Realm  </a>
      
    </header>
    <div class="right tab-menu menu">
      
        <a class="item" data-tab="Lab-05-a">
          Lab-05-a
        </a>
      
        <a class="item" data-tab="01">
          01
        </a>
      
        <a class="item" data-tab="02">
          02
        </a>
      
        <a class="item" data-tab="03">
          03
        </a>
      
        <a class="item" data-tab="Solution">
          Solution
        </a>
      
    </div>
  </div>


  

  <div class="ui pushable">
    <div class="ui inverted labeled icon left inline vertical sidebar menu">
      <br><br>
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic01-overview-and-tools/unit-1/book-coffeemate-lab-01/index.html">Lab-01 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic02-ui-design/unit-1/book-coffeemate-lab-02/index.html">Lab-02 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic02-ui-design/unit-1/book-coffeemate-lab-03/index.html">Lab-03 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic02-ui-design/unit-2/book-coffeemate-lab-04/index.html">Lab-04 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic03-persistence/unit-1/book-coffeemate-lab-05-a/index.html">Lab-05-a </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic03-persistence/unit-1/book-coffeemate-lab-05-b/index.html">Lab-05-b </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic04-networking/unit-1/book-coffeemate-lab-06-a/index.html">Lab-06-a </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic04-networking/unit-1/book-coffeemate-lab-06-b/index.html">Lab-06-b </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic05-google-services/unit-1/book-coffeemate-lab-07/index.html">Lab-07 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic05-google-services/unit-1/book-coffeemate-lab-08/index.html">Lab-08 </a>
          
        
      
        
          
            <a class="item"
               href="http://ddrohan.github.io/wit-mad-msc-2019//topic06-firebase/unit-1/book-coffeemate-lab-09/index.html">Lab-09 </a>
          
        
      
    </div>
    <div class="pusher" tabindex="-1">
      <div class="ui basic segment">
        <br>
        
          <div class="ui tab segment lab" data-tab="Lab-05-a">
            <h1>Objectives</h1>
<p>This lab continues our Case Study <b>CoffeeMate</b> and implements persistence (through an SQLite Database) in an Android App.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="01">
            <h1>Setup - Starter Code</h1>
<p>You can continue on with your own version of <b>CoffeeMate</b> for this lab, but if you wish, you can download the starter code here - <a href="archives/CoffeeMate.5a.0.Starter.zip">CoffeeMate.5a.0.Starter</a>.</p>
<p>In this lab, you are required to do the following:</p>
<ul>
<li>Add Database Support to CoffeeMate to manage our coffees which will allow them to be persisted in an SQLite database</li>
</ul>
<p>The following steps will guide you through these requirements, but first you&#39;ll need to download some helper classes <a href="archives/database.zip">here</a> to make this lab a bit easier.</p>
<p>Once you&#39;ve downloaded the archive, add them to a new <strong><em>ie.cm.db</em></strong> package in your project.</p>
<p>You&#39;ll get a small error in your Coffee Model, so fix that (just change the type and comment out the relevant line in the constructor).</p>
<p>Take a few moments to investigate the classes and familiarise yourself with the methods you&#39;ll be using. There are a number of classes you&#39;ll need to modify to add database support to your project.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="02">
            <h1>App Refactoring - Adding Database Support</h1>
<p>Once you&#39;ve imported the necessary Database classes and placed them in the correct package, (and fixed any errors) this step is relatively straight forward - all you have to do is replace the method calls that manages the <strong>coffeeList</strong> with the respective <strong>dbManager</strong> calls.</p>
<p> The first thing you need to do is create an instance of <strong><em>DBManager</em></strong> in <strong>CofeeMateApp.java</strong> and both open/close the database when necessary.</p>
<p>Our DBManager instance inside our Application Object should now look like this :</p>
<pre><code class="lang-java">public class CoffeeMateApp extends Application {    
    //public List &lt;Coffee&gt;  coffeeList = new ArrayList&lt;Coffee&gt;();    
    public DBManager dbManager = new DBManager(this);    

    @Override    
    public void onCreate()    
    {        
        super.onCreate();        
        Log.v(&quot;coffeemate&quot;, &quot;CoffeeMate App Started&quot;);        
        dbManager.open();    
    }    

    @Override    
    public void onTerminate()
    {        
    super.onTerminate();        
    dbManager.close();    
    }
}</code></pre>
<p>Once you make this change (and save the file) you&#39;ll get a number of errors, which actually indicates which classes you need to now update and add the database calls (and remove the coffeeList calls). Each error requires only one line of code to be fixed, so have a go and updating each of the classes (and we&#39;ll have a look at the solution at the end of the Practical Lab).</p>
<p>Once you fix all the errors, and run the app again, you should see your coffee list - but this time those coffees are stored in a database.</p>
<p>And as a final check, if you call the <strong><em>setupList()</em></strong> method of the <strong><em>DBManager</em></strong> reference in your <strong>CoffeeMateApp</strong> reference &#39;app&#39; (replacing the existing setup method in &#39;Home&#39;) you should see the following list:</p>
<p><img src="img/sqlitescreen1.png" alt=""></p>
<p>and if you choose the menu (assuming you&#39;ve downloaded the starter code)</p>
<p><img src="img/sqlitescreen2.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="03">
            <h1>App Refactoring - Editing / Deleting Multiple Coffees</h1>
<p>After some testing you may find that your adapter isn&#39;t functioning as expected in certain circumstances when deleting multiple coffees. This is due to the fact that our data is now persistent, so depending on &#39;where you are&#39;, so to speak, some slight refactoring of our <b>deleteCoffees()</b> is required, like so</p>
<pre><code class="lang-java">public void deleteCoffees(ActionMode actionMode)
  {
    Coffee c = null;
    for (int i = listAdapter.getCount() - 1; i &gt;= 0; i--) {
      if (listView.isItemChecked(i)) {
        activity.app.dbManager.delete(listAdapter.getItem(i).coffeeId); //delete from DB
        listAdapter.coffeeList.remove(listAdapter.getItem(i)); // update adapters data
      }
    }

    actionMode.finish();

    if (favourites) {
      //Update the filters data
      coffeeFilter = new CoffeeFilter(activity.app.dbManager.getAll(),&quot;favourites&quot;,listAdapter);
      coffeeFilter.filter(null);
    }
    listAdapter.notifyDataSetChanged();
  }</code></pre>
<p>And make sure you test you &#39;Edit&#39; also, as there&#39;s some refactoring required here also</p>
<p><code>HINT : You&#39;ll need to use your Application Object reference to hook into your database, before you can Update</code></p>
<p>Even after you&#39;ve refactored your <code>EditFragment</code> you may notice that on returning to the &#39;Home Screen&#39; the coffee hasn&#39;t been updated (even though it has been in the database).</p>
<p>There&#39;s a few options here to fix this, you could go with creating a new <code>Fragment Transaction</code> and replacing the &#39;Home Screen&#39; <code>CoffeeFragment</code> with a new version of itself, like so</p>
<pre><code class="lang-java">getActivity().setTitle(R.string.recentlyViewedLbl);
Fragment fragment = CoffeeFragment.newInstance();
((CoffeeFragment)fragment).favourites = false;
getActivity().getSupportFragmentManager()
        .beginTransaction().replace(R.id.homeFrame, fragment)
        .addToBackStack(null)
        .commit();</code></pre>
<p>This is a fix for this particular bug, but doesn&#39;t handle the &#39;Back Button&#39; through multiple screens (another bug!! test it and see) so I went with simply moving</p>
<pre><code class="lang-java">listAdapter = new CoffeeListAdapter(activity, this, activity.app.dbManager.getAll());
 coffeeFilter = new CoffeeFilter(activity.app.dbManager.getAll(),&quot;all&quot;,listAdapter);</code></pre>
<p>from the <code>onCreate()</code> method to the <code>onCreateView()</code> method and make sure you call</p>
<pre><code class="lang-java"> super.onCreateView(inflater,container,savedInstanceState);</code></pre>
<p>in the subclass <code>SearchFragment</code> method, to avoid a NullPointerException on setting the filter.</p>
<p>Test again to confirm and go have a coffee!</p>
<p>Well Done!</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="Solution">
            <h1>Solution</h1>
<p>This is a solution to the lab:</p>
<ul>
<li><a href="archives/CoffeeMate.5a.0.Solution.zip">CoffeeMate.5a.0.Solution</a></li>
</ul>

          </div>
        
      </div>
    </div>
  </div>



  <script>
    $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

    $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

  </script>



  <div class="ui bottom fixed borderless right menu">
    <div class="ui right small menu">
      <div class="ui tiny basic message segment">
         Powered by <a href="https://github.com/edeleastar/tutors-ts">tutors-ts.</a> 
      </div>
    </div>
  </div>

  </body>

</html>